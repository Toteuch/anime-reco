<!doctype html>
<html data-bs-theme="dark" lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <title>Anime-Reco</title>
    <link rel="stylesheet" th:href="@{/css/bootstrap-5.3.3.min.css}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/anime-reco.css}">
</head>
<body>
<main class="container" role="main">
    <nav th:replace="~{fragments/general.html :: navbar}"></nav>
    <button class="btn btn-primary" data-bs-target="#filterModal" data-bs-toggle="modal" type="button">
        Filter
    </button>
    <div class="modal" id="filterModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-body">
                    <div class="d-flex">
                        <div class="p-2 flex-grow-1">
                            <input class="form-control" id="filterTitleInput" placeholder="Title" type="text">
                        </div>
                        <div class="p-2">
                            <button class="btn btn-primary" type="button">
                                <svg class="bi bi-floppy" fill="currentColor" height="16" viewBox="0 0 16 16"
                                     width="16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M11 2H9v3h2z"/>
                                    <path d="M1.5 0h11.586a1.5 1.5 0 0 1 1.06.44l1.415 1.414A1.5 1.5 0 0 1 16 2.914V14.5a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 14.5v-13A1.5 1.5 0 0 1 1.5 0M1 1.5v13a.5.5 0 0 0 .5.5H2v-4.5A1.5 1.5 0 0 1 3.5 9h9a1.5 1.5 0 0 1 1.5 1.5V15h.5a.5.5 0 0 0 .5-.5V2.914a.5.5 0 0 0-.146-.353l-1.415-1.415A.5.5 0 0 0 13.086 1H13v4.5A1.5 1.5 0 0 1 11.5 7h-7A1.5 1.5 0 0 1 3 5.5V1H1.5a.5.5 0 0 0-.5.5m3 4a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 .5-.5V1H4zM3 15h10v-4.5a.5.5 0 0 0-.5-.5h-9a.5.5 0 0 0-.5.5z"/>
                                </svg>
                            </button>
                        </div>
                        <div class="p-2">
                            <button class="btn btn-primary" type="button">
                                <svg class="bi bi-folder2" fill="currentColor" height="16" viewBox="0 0 16 16"
                                     width="16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M1 3.5A1.5 1.5 0 0 1 2.5 2h2.764c.958 0 1.76.56 2.311 1.184C7.985 3.648 8.48 4 9 4h4.5A1.5 1.5 0 0 1 15 5.5v7a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 12.5zM2.5 3a.5.5 0 0 0-.5.5V6h12v-.5a.5.5 0 0 0-.5-.5H9c-.964 0-1.71-.629-2.174-1.154C6.374 3.334 5.82 3 5.264 3zM14 7H2v5.5a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="pb-2 p-2">
                        <label for=mediaTypesGroup>Media Types</label>
                        <div aria-label="Media Types" class="btn-group" id="mediaTypesGroup" role="group">

                        </div>
                    </div>
                    <div class="pb-2 d-flex">
                        <label class="p-2" for="minSeasonInput">From</label>
                        <input class="form-control p-2 w-5" id="minSeasonInput" type="number"/>
                        <label class="p-2" for="maxSeasonInput">To</label>
                        <input class="form-control p-2 w-5" id="maxSeasonInput" type="number"/>
                        <label class="p-2 ps-5" for="statusGroup">Status</label>
                        <div aria-label="Status" class="btn-group" id="statusGroup" role="group">

                        </div>
                    </div>
                    <div class="pb-2">
                        <label class="p-2">Genres</label>
                    </div>
                    <div class="pb-2">
                        <div aria-label="Genres" class="btn-group justify-content-center" id="genresGroup" role="group">

                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Cancel</button>
                    <button class="btn btn-primary" type="button">Apply</button>
                </div>
            </div>
        </div>
    </div>
    <div class="mb-3">
        <label class="form-label" for="filterNameFormInput">Name</label>
        <input class="form-control" id="filterNameFormInput" type="text">
    </div>
    <div class="mb-3">
        <button onclick="create();">create</button>
    </div>
</main>
<script th:src="@{/js/jquery-3.7.1.js}"></script>
<script th:src="@{/js/popper-1.14.3.min.js}"></script>
<script th:src="@{/js/bootstrap-5.3.3.bundle.min.js}"></script>
<script th:src="@{/js/anime-reco.js}"></script>
<script>
    $(function() {
        displayMediaTypes();
        displayStatus();
        displayGenres();
    });

    function activate3States() {
        $('button[type="button"][class~="btn-filter-3"]').on('click', function() {
            var colorClasses = ["btn-outline-primary", "btn-primary", "btn-danger"];
            var $radios = $('input[type="radio"][name="' + $(this).attr('id') + '"]');
            alert($(this).attr('id'));
            var $checked = $radios.filter(':checked');
            var $next = $radios.eq($radios.index($checked) + 1);
            if (!$next.length) {
                $next = $radios.first();
            }
            $next.prop("checked", true);
            var newValue = $radios.filter(':checked').val();
            $(this)
                .removeClass(colorClasses.join(" "))
                .addClass(colorClasses[newValue]);
        });
    }

    function displayGenres() {
        $.ajax({
            type: "GET",
            headers: {"X-CSRF-Token": $('#csrf-token').val()},
            url: window.location.protocol + "//" + window.location.host + "/search-filter/genre",
            dataType: 'json',
            success: function(data) {
                var genresMap = new Map(Object.entries(data));
                let html = "";
                /*for(const [key, value] of genresMap) {
                    html+=`
                        <input checked hidden name="g_`+key+`" type="radio" value="0"/>
                        <input hidden name="g_`+key+`" type="radio" value="1"/>
                        <input hidden name="g_`+key+`" type="radio" value="2"/>
                    `;
                }*/
                for(const [key, value] of genresMap) {
                    html+=`
                        <button class="btn btn-filter-3 btn-outline-primary" id="g_`+key+`" type="button">`+value+`</button>
                    `;
                }
                $('#genresGroup').html(html);
                activate3States();
            }
        });
    }

    function displayStatus() {
        $.ajax({
            type: "GET",
            headers: {"X-CSRF-Token": $('#csrf-token').val()},
            url: window.location.protocol + "//" + window.location.host + "/search-filter/status",
            dataType: 'json',
            success: function(data) {
                var statusMap = new Map(Object.entries(data));
                let html = "";
                for(const [key, value] of statusMap) {
                    html += `
                        <input autocomplete="off" class="btn-check" id="s_${key}" type="checkbox"/>
                        <label class="btn btn-outline-primary" for="s_${key}">${value}</label>
                    `;
                }
                $('#statusGroup').html(html);
            }
        });
    }

    function displayMediaTypes() {
        $.ajax({
            type: "GET",
            headers: {"X-CSRF-Token": $('#csrf-token').val()},
            url: window.location.protocol + "//" + window.location.host + "/search-filter/media-type",
            dataType: 'json',
            success: function(data) {
                var mediaTypes = new Map(Object.entries(data));
                let html = "";
                for(const [key, value] of mediaTypes) {
                    html += `
                        <input autocomplete="off" class="btn-check" id="mt_${key}" type="checkbox"/>
                        <label class="btn btn-outline-primary" for="mt_${key}">${value}</label>
                    `;
                }
                $('#mediaTypesGroup').html(html);
            }
        });
    }

    function create() {
        let body = {
            "name": $('#filterNameFormInput').val(),
            "mediaTypes": ["tv", "movie"],
            "status": ["not_aired_yet"],
            "minSeasonYear": 2010,
            "genres": [4,22]
        };
        $.ajax({
            type: "POST",
            headers: {"X-CSRF-Token": $('#csrf-token').val()},
            url: window.location.protocol + "//" + window.location.host + "/search-filter",
            data: JSON.stringify(body),
            contentType: 'application/json',
            dataType: 'json',
            success: function(data) {
                if (data.error != null) {
                    alert(data.error);
                } else {
                    alert("filter created");
                }
            }
        });
    }
</script>
</body>
</html>